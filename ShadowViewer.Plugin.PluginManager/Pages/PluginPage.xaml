<Page
    x:Class="ShadowViewer.Plugin.PluginManager.Pages.PluginPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="using:CommunityToolkit.WinUI.Converters"
    xmlns:converters1="using:ShadowViewer.Plugin.PluginManager.Converters"
    xmlns:core="using:ShadowViewer.Sdk"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:extensions="using:ShadowViewer.Sdk.Extensions"
    xmlns:fluent="using:FluentIcons.WinUI"
    xmlns:helpers="using:ShadowViewer.Plugin.PluginManager.Helpers"
    xmlns:i18N="using:ShadowViewer.Plugin.PluginManager.I18n"
    xmlns:icx="using:FluentIcons.WinUI.Markup"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:ShadowViewer.Plugin.PluginManager.Models"
    x:Name="ThisPage"
    NavigationCacheMode="Required"
    mc:Ignorable="d">
    <Page.Resources>
        <converters:EmptyObjectToObjectConverter
            x:Key="EmptyObjectToVisibilityConverter"
            EmptyValue="Collapsed"
            NotEmptyValue="Visible" />
        <converters1:PluginMoreVisibilityConverter x:Key="PluginMoreVisibilityConverter" />
    </Page.Resources>
    <Grid
        Background="{ThemeResource LayerFillColorDefaultBrush}"
        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
        BorderThickness="1"
        CornerRadius="{ThemeResource NavigationViewContentGridCornerRadius}">
        <Grid Loaded="SecurityContentDialog_OnLoaded">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            <Grid
                Grid.Row="0"
                Padding="36,40,36,0"
                ColumnSpacing="8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <TextBlock
                    Grid.Column="0"
                    FontSize="25"
                    Text="{i18N:Locale Key=PluginManager}" />
                <CommandBar
                    x:Name="LeftCommandBar"
                    Grid.Column="2"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Center"
                    Background="Transparent"
                    DefaultLabelPosition="Right"
                    IsOpen="False">
                    <AppBarButton
                        Command="{x:Bind ViewModel.AddPluginCommand}"
                        CommandParameter="{x:Bind XamlRoot}"
                        Icon="{icx:SymbolIcon Symbol=AddCircle}"
                        Label="{i18N:Locale Key=AddPlugin}"
                        ToolTipService.ToolTip="{i18N:Locale Key=AddPlugin}" />
                    <AppBarButton
                        Icon="{icx:SymbolIcon Symbol=Tag}"
                        Label="{x:Bind ViewModel.SdkVersion, Mode=OneWay}"
                        ToolTipService.ToolTip="{x:Bind ViewModel.SdkVersion, Mode=OneWay}" />
                    <AppBarButton
                        Command="{x:Bind ViewModel.ToPluginStorePageCommand}"
                        Icon="{icx:SymbolIcon Symbol=Search}"
                        IsEnabled="{x:Bind ViewModel.PluginSecurityCheck, Mode=OneWay}"
                        Label="{i18N:Locale Key=PluginStore}"
                        ToolTipService.ToolTip="{i18N:Locale Key=GoPluginTip}" />
                </CommandBar>
            </Grid>

            <GridView
                Grid.Row="1"
                Margin="28"
                ItemsSource="{x:Bind ViewModel.Plugins, Mode=OneWay}"
                SelectionMode="None">
                <GridView.ItemTemplate>
                    <DataTemplate x:DataType="models:UiPlugin">
                        <Grid
                            Width="360"
                            Height="260"
                            Margin="8"
                            Padding="16"
                            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                            BorderThickness="1"
                            CornerRadius="8"
                            RowSpacing="8">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="*" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>
                            <Grid Grid.Row="0" ColumnSpacing="16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="64" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <Grid
                                    Grid.Column="0"
                                    Width="64"
                                    Height="64"
                                    Background="{ThemeResource SolidBackgroundFillColorTertiaryBrush}"
                                    BorderBrush="{ThemeResource SolidBackgroundFillColorSecondaryBrush}"
                                    BorderThickness="1"
                                    CornerRadius="4">
                                    <Viewbox
                                        Width="54"
                                        Height="54"
                                        extensions:PluginLogoViewboxExtensions.PluginLogo="{x:Bind MetaData.Logo, Mode=OneWay, Converter={StaticResource PluginPathConverter}}" />

                                </Grid>
                                <Grid
                                    Grid.Column="1"
                                    Padding="0,4"
                                    RowSpacing="6">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="*" />
                                    </Grid.RowDefinitions>
                                    <TextBlock
                                        Grid.Row="0"
                                        FontSize="19"
                                        FontWeight="Bold"
                                        Text="{x:Bind MetaData.Name, Mode=OneWay}"
                                        TextTrimming="CharacterEllipsis" />
                                    <TextBlock
                                        Grid.Row="1"
                                        FontSize="16"
                                        Foreground="Gray"
                                        Text="{x:Bind MetaData.Authors, Mode=OneWay}"
                                        TextTrimming="CharacterEllipsis" />
                                </Grid>
                                <HyperlinkButton
                                    Grid.Column="2"
                                    Width="37"
                                    Height="37"
                                    Padding="5"
                                    VerticalAlignment="Top"
                                    NavigateUri="{x:Bind MetaData.WebUri, Mode=OneWay}">
                                    <ImageIcon
                                        Width="25"
                                        Height="25"
                                        Source="{ThemeResource GithubIcon}" />
                                </HyperlinkButton>
                            </Grid>
                            <Grid Grid.Row="1">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <StackPanel
                                    Grid.Column="0"
                                    Orientation="Horizontal"
                                    Spacing="4">

                                    <ToolTipService.ToolTip>
                                        <TextBlock>
                                            <Run Text="Id" />
                                            <Run Text=": " />
                                            <Run Text="{x:Bind helpers:PluginNameHelper.GetPluginId(MetaData.Id), Mode=OneWay}" />
                                        </TextBlock>
                                    </ToolTipService.ToolTip>
                                    <fluent:SymbolIcon
                                        FontSize="14"
                                        Foreground="Gray"
                                        Symbol="PuzzlePiece" />
                                    <TextBlock Foreground="Gray" Text="{x:Bind helpers:PluginNameHelper.GetPluginId(MetaData.Id), Mode=OneWay}" />
                                </StackPanel>
                                <StackPanel
                                    Grid.Column="2"
                                    Orientation="Horizontal"
                                    Spacing="4">

                                    <ToolTipService.ToolTip>
                                        <TextBlock>
                                            <Run Text="{i18N:Locale Key=Version}" />
                                            <Run Text=": " />
                                            <Run Text="{x:Bind MetaData.Version, Mode=OneWay}" />
                                        </TextBlock>
                                    </ToolTipService.ToolTip>
                                    <fluent:SymbolIcon
                                        FontSize="14"
                                        Foreground="Gray"
                                        Symbol="Lightbulb" />
                                    <TextBlock Foreground="Gray" Text="{x:Bind MetaData.Version, Mode=OneWay}" />
                                </StackPanel>
                            </Grid>
                            <TextBlock
                                Grid.Row="2"
                                FontSize="17"
                                Text="{x:Bind MetaData.Description, Mode=OneWay}"
                                TextTrimming="CharacterEllipsis"
                                TextWrapping="Wrap" />
                            <Grid Grid.Row="3">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <ToggleSwitch
                                    Grid.Column="0"
                                    IsEnabled="{x:Bind CanSwitch, Mode=OneWay}"
                                    IsOn="{x:Bind IsEnabled, Mode=TwoWay}" />
                                <HyperlinkButton
                                    Grid.Column="2"
                                    Width="37"
                                    Height="37"
                                    Padding="5"
                                    Command="{Binding ElementName=ThisPage, Path=ViewModel.ToPluginSettingPageCommand}"
                                    CommandParameter="{x:Bind SettingsPage, Mode=OneWay}">
                                    <fluent:SymbolIcon Symbol="Settings" />
                                </HyperlinkButton>
                                <HyperlinkButton
                                    Grid.Column="3"
                                    Width="37"
                                    Height="37"
                                    Padding="5"
                                    extensions:ButtonExtensions.ClickShowFlyout="True">
                                    <fluent:SymbolIcon Symbol="MoreHorizontal" />
                                    <FlyoutBase.AttachedFlyout>
                                        <MenuFlyout Placement="Right">
                                            <MenuFlyoutItem
                                                Command="{Binding ElementName=ThisPage, Path=ViewModel.OpenFolderCommand}"
                                                CommandParameter="{x:Bind PluginType, Mode=OneWay}"
                                                Icon="Folder"
                                                IsEnabled="{x:Bind CanOpenFolder, Mode=OneWay}"
                                                Text="{i18N:Locale Key=OpenFolder}" />
                                            <MenuFlyoutItem
                                                Command="{Binding ElementName=ThisPage, Path=ViewModel.DeleteCommand}"
                                                CommandParameter="{x:Bind MetaData.Id, Mode=OneWay}"
                                                Icon="Delete"
                                                IsEnabled="{x:Bind CanDelete, Mode=OneWay}"
                                                Text="{i18N:Locale Key=Delete}" />
                                        </MenuFlyout>
                                    </FlyoutBase.AttachedFlyout>
                                </HyperlinkButton>
                            </Grid>
                        </Grid>
                    </DataTemplate>
                </GridView.ItemTemplate>
            </GridView>
        </Grid>

        <ContentDialog
            x:Name="SecurityContentDialog"
            Title="{i18N:Locale Key=PluginSecurityStatement}"
            CloseButtonText="{i18N:Locale Key=Cancel}"
            DefaultButton="Primary"
            IsPrimaryButtonEnabled="{x:Bind ViewModel.PluginSecurityCheck, Mode=OneWay}"
            PrimaryButtonCommand="{x:Bind ViewModel.SecurityConfirmCommand}"
            PrimaryButtonText="{i18N:Locale Key=PluginSecurityConfirm}">
            <StackPanel Spacing="10">
                <TextBlock TextWrapping="Wrap">
                    <Run Text="{i18N:Locale Key=PluginSecurity_Start}" />
                    <LineBreak />
                    <Run
                        FontSize="18"
                        FontWeight="Bold"
                        Text="{i18N:Locale Key=PluginSecurity_Source}" />
                    <LineBreak /><Run Text="{i18N:Locale Key=PluginSecurity_Source_Content}" />
                    <LineBreak />
                    <Run
                        FontSize="18"
                        FontWeight="Bold"
                        Text="{i18N:Locale Key=PluginSecurity_Permission}" />
                    <LineBreak /><Run Text="{i18N:Locale Key=PluginSecurity_Permission_Content}" />
                    <LineBreak />
                    <Run
                        FontSize="18"
                        FontWeight="Bold"
                        Text="{i18N:Locale Key=PluginSecurity_CodeRisk}" />
                    <LineBreak /><Run Text="{i18N:Locale Key=PluginSecurity_CodeRisk_Content}" />
                    <LineBreak />
                    <Run
                        FontSize="18"
                        FontWeight="Bold"
                        Text="{i18N:Locale Key=PluginSecurity_Responsibility}" />
                    <LineBreak /><Run Text="{i18N:Locale Key=PluginSecurity_Responsibility_Content}" />
                </TextBlock>

                <CheckBox Content="{i18N:Locale Key=PluginSecurityCheck}" IsChecked="{x:Bind ViewModel.PluginSecurityCheck, Mode=TwoWay}" />
            </StackPanel>
        </ContentDialog>
    </Grid>
</Page>